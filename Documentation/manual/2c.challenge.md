# Challenge other player system

Challenges takes the form of a variable called challengedPlayer. This variable is in the user lobby server data and can have 3 available values:

* "PLAYFABID_OTHERPLAYFABID_RANDOMNUMBER": This value refers to a challenge made from one player to other. This value will also be used as the matchId of the match.
* "CANCELED" : This value refers to a player that canceled a challenge that someone else did to him.
* "": Empty message, player isn't sending challenge to anybody.

In the [ChallengePlayer.cs]() class most of the logic of this functionality is executed. For example, the [CheckChallenge()]() handles both recieving and initiating a combat. Basically, it checks if the player can recieve or challenge someone and if so then it created the matchId and then creates the match sending to the server the petition to create it. Then it waits for the other player to confirm the match. Then once it's confirmed they both enter to the shinsei selection screen. 

The game checks the server to see the challenges and responses of other players in the [LobbyNetworkingController.cs](/SacredTailsDocumentation/api/Timba.Games.SacredTails.LobbyNetworking.LobbyNetworkingController.html), more precisely in the [PlayerChallengeVerification()](). This method is executed in local for every player in order to check if any player has a challenge for the local player or to know if the player has a challenge to other player. Let's see a pseudocode of the method:

```cs
//WARNING: PSEUDOCODE not real code

        public void PlayerChallengeVerification(KeyValuePair<string, LobbyPlayerBasePayload> item)
        {
            // We check if the challenge variable on server has any value.
            if (!emptyChallenge)
            {
                // If the challenge on the player hasn't change since the last time we check the server data
                // And if the other challeged player has a "CANCEl" in his challenge variable.
                if (isMatchSameAsLastOne && challengedPlayerCanceledMatch)
                {
                    // We proceed to cancel the challenge and erase both players challenge variable in this player local data.
                    if (isLocalPlayer)
                    {
                        // Erase challenge data on local and send it to the server
                        PlayerDataManager.Singleton.localPlayerData.challengedPlayer = "";
                        TickCheckActivates();
                    }
                    currentPlayersAvatar[item.Key].challengePlayerController.MatchCanceledByChallenged(isLocalPlayer);
                    currentPlayersAvatar[playfabIdChallengedPlayer].challengePlayerController.MatchCanceledByChallenged(isLocalPlayer);
                }
                else if (isCurrentPlayer && canceledAlreadyProcessed)
                {
                    // If it has a "CANCEL" value on local player challenge variable and the canceled was already processed.
                    // We erase the "CANCEL" to a "" and send it to the server.
                    PlayerDataManager.Singleton.localPlayerData.challengedPlayer = "";
                    TickCheckActivates();
                }
                else if (currentPlayerHasChallenge)
                {
                    // If there is a challenge for me call the challenge player controller 
                    // to open a popup with the challenge
                    currentPlayer.challengePlayerController.RecieveChallenge(currentPlayersAvatar[item.Key], randomMatchNumber);
                }
            }
        }
```
