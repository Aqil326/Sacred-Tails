# Chat system

The chats system flow has three parts: sending messages, recieving messages and the bad word filter.

- [Chat system](#chat-system)
  - [Recieving message](#recieving-message)
  - [Sending a message](#sending-a-message)
  - [Bad word filter](#bad-word-filter)
  

## Recieving message

Recieving message flow starts when the lobby gets the messages from the player, in the [ManageLobby()](/SacredTailsDocumentation/api/Timba.Games.SacredTails.LobbyNetworking.LobbyNetworkingController.html#Timba_Games_SacredTails_LobbyNetworking_LobbyNetworkingController_ManageLobbyPlayers_System_Collections_Generic_Dictionary_System_String_LobbyPlayerBasePayload__) method inside the [LobbyNetworkingController.cs](/SacredTailsDocumentation/api/Timba.Games.SacredTails.LobbyNetworking.LobbyNetworkingController.html). Basically, it order the messages by their timestamp and then send them in the chat textbox with the [ChatTextBox.cs](/api/Global.ChatTextBox.html)
```cs
    ...

    List<ChatMessagePayload> chatMesssagesSorted = item.Value.chatMessages?.OrderBy(o => o.timeStamp).ToList();
    if (chatMesssagesSorted != null)
        foreach (var chatMessage in chatMesssagesSorted)
            chatTextBox.SendMessage(chatMessage, item.Value.displayName, item.Key.Equals("54BB079356042E83"));

    ...
```

The [SendMessage()](/api/Global.ChatTextBox.html#Global_ChatTextBox_SendMessage_ChatMessagePayload_System_String_) methods sends the message verifiyng if it's already writter, has bad words or if it's an admin.

```cs
    public void SendMessage(ChatMessagePayload chatMessage, string displayName, bool isAdmin = false)
    {
        if (alreadyWriteMessages.Contains(chatMessage.id))
            return;

        if (PlayerPrefs.GetInt("BadWordFilterOption", 1) == 1)
            chatMessage.message = CheckForBadWords(chatMessage.message);

        alreadyWriteMessages.Add(chatMessage.id);
        if (isAdmin)
            AddText($"<color=red>[ADMIN] </color>: {chatMessage.message}");
        else
            AddText($"<color=#EFEBCE>[Server] ({displayName}): {chatMessage.message}</color>");
    }
```

## Sending a message

The [SendLocalMessage](/api/Global.ChatTextBox.html#Global_ChatTextBox_SendLocalMessage) method handles the sending of a message in the chat. Checks if has bad words, check if it's directed to someone and then add it to the list of messages of the player in order to send it on the next update of the server.
```cs
    public void SendLocalMessage()
    {
        if (String.IsNullOrWhiteSpace(chatInput.text))
            return;

        if (PlayerPrefs.GetInt("BadWordFilterOption", 1) == 1)
            chatInput.text = CheckForBadWords(chatInput.text);

        // Whisper verification
        if (!chatInput.text.Contains("/r "))
            AddText($"<color=#DFDBC0>[Server] ({PlayerDataManager.Singleton.localPlayerData.playerName}): {chatInput.text}</color>");
        else
        {
            string[] trimText = chatInput.text.Split(' ');
            AddText($"<color=#E146CD>[To] ({trimText[1]}): {(chatInput.text).Replace("/r " + trimText[1],"")}</color>");
            PlayerPrefs.SetString("LastWhisper", trimText[1]);
        }

        //Add to list of player messages in order to send it on the next update of the server.
        PlayerDataManager.Singleton.localPlayerData.currentChatMessages.Add(new ChatMessagePayload() { message = chatInput.text, timeStamp = DateTime.UtcNow.ToString("o", CultureInfo.InvariantCulture) });

        chatInput.text = "";
        chatInput.Select();
        chatInput.ActivateInputField();
    }
```

The server only conserves the messages for X time and then deletes them from the player in order to not store huge amounts of data.

## Bad word filter

The bad world filter takes a dictionary previosly initialize from a json file and takes the message and check if the message contains a word that is a bad word in any of the languages and return the messages with the bad words filtered.

```cs
    public ChatBadWordsDB badWordsDB;

    public struct ChatBadWordsDB
    {
        public List<List<string>> listOfBadWords;
    }

    public string CheckForBadWords(string message)
    {
        string[] messageWords = message.Split(' ');

        for (int i = 0; i < messageWords.Length; i++)
        {
            string word = messageWords[i];
            foreach (List<string> languageBadWords in badWordsDB.listOfBadWords)
            {
                if (languageBadWords.Contains(word.ToLower()) )
                {
                    messageWords[i] = "****";
                    break;
                }
            }
        }

        string resultAfterFilter = "";
        foreach (var word in messageWords)
            resultAfterFilter += $"{word} ";

        return resultAfterFilter;
    }
```
